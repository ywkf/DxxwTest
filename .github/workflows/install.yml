name: install

on:
  push:
    tags:
      - "v*"
    branches:
      - "**"
    paths:
      - ".github/workflows/install.yml"
      - "assets/**"
      - "**.py"
  pull_request:
    branches:
      - "**"
    paths:
      - ".github/workflows/install.yml"
      - "assets/**"
      - "**.py"
  workflow_dispatch:

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: set_tag
        run: |
          is_release=${{ startsWith(github.ref, 'refs/tags/v') }}
          tag=$(git describe --tags --match "v*" ${{ github.ref }} || true)
          if [[ $tag != v* ]]; then
            tag=$(curl -sX GET "https://api.github.com/repos/${{ github.repository }}/releases/latest" --header 'authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' | awk '/tag_name/{print $4}' FS='["]')
            if [[ $tag != v* ]]; then
              tag="v0.0.0"
            fi
            tag=$(date "+$tag-%y%m%d-$(git rev-parse --short HEAD)")
          fi
          if ! $($is_release) ; then
            prefix=${tag%-*-*}
            suffix=${tag#$prefix-}
            tag="$prefix-ci.$suffix"
          fi

          echo tag=$tag | tee -a $GITHUB_OUTPUT
          echo is_release=$is_release | tee -a $GITHUB_OUTPUT
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
      is_release: ${{ steps.set_tag.outputs.is_release }}

  windows:
  needs: meta
  runs-on: windows-latest
  strategy:
    matrix:
      arch: [x86_64]
    fail-fast: false

  steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    # 下载MaaFramework
    - name: Download MaaFramework
      uses: robinraju/release-downloader@v1
      with:
        repository: MaaXYZ/MaaFramework
        fileName: "MAA-win-${{ matrix.arch }}*"
        latest: true
        out-file-path: "deps"
        extract: true
      
    # 下载MFAWPF（如果需要两个UI版本）
    - name: Download MFAWPF
      uses: robinraju/release-downloader@v1  
      with:  
        repository: SweetSmellFox/MFAWPF  
        fileName: "MFAWPF*"
        latest: true  
        out-file-path: "MFAWPF"  
        extract: true     

    # 下载MFAAvalonia
    - name: Download MFAAvalonia
      id: download_mfa
      uses: robinraju/release-downloader@v1  
      with:
        repository: SweetSmellFox/MFAAvalonia
        fileName: "MFAAvalonia-*-win-x64*"  # 简化，因为只用了x86_64
        latest: true
        out-file-path: "MFAAvalonia"
        extract: true

    # 清理下载的压缩包
    - name: Clean up archives
      shell: bash
      run: |
        echo "Cleaning up downloaded archives..."
        rm -f MFAWPF/*.zip MFAWPF/*.tar.gz 2>/dev/null || true
        rm -f MFAAvalonia/*.zip MFAAvalonia/*.tar.gz 2>/dev/null || true

    # 安装主程序（Full版本的基础）
    - name: Install main application
      shell: bash
      run: |
        python ./install.py ${{ needs.meta.outputs.tag }}
        
        # 确保install目录存在
        mkdir -p install
        
        # 复制MFAWPF到install目录（Full版本）
        if [ -f "MFAWPF/MFAWPF.exe" ]; then
          echo "Copying MFAWPF.exe to install directory..."
          cp -v "MFAWPF/MFAWPF.exe" "install/"
          # 复制MFAWPF的dll文件
          find MFAWPF -name "*.dll" -type f -exec cp -v {} "install/" 2>/dev/null || true
        fi
        
        # 复制MFAAvalonia到install目录（Full版本）
        if [ -d "MFAAvalonia" ]; then
          echo "Copying MFAAvalonia files to install directory..."
          # 复制MFAAvalonia.exe
          if [ -f "MFAAvalonia/MFAAvalonia.exe" ]; then
            cp -v "MFAAvalonia/MFAAvalonia.exe" "install/"
          fi
          # 复制所有dll文件
          find MFAAvalonia -name "*.dll" -type f -exec cp -v {} "install/" 2>/dev/null || true
          # 复制配置文件
          find MFAAvalonia \( -name "*.json" -o -name "*.config" -o -name "*.deps.json" \) -type f -exec cp -v {} "install/" 2>/dev/null || true
        fi

    # 创建CLI版本（Lite版本）- 不包含GUI文件
    - name: Create CLI version
      shell: bash
      run: |
        echo "Creating CLI version..."
        mkdir -p install-cli
        
        # 复制主程序文件，排除GUI相关文件
        if [ -d "install" ]; then
          # 复制所有文件
          cp -rpvn install/. install-cli/
          
          # 删除GUI可执行文件（Lite版本不包含）
          rm -f install-cli/MFAWPF.exe 2>/dev/null || true
          rm -f install-cli/MFAAvalonia.exe 2>/dev/null || true
          
          # 可以添加其他需要删除的GUI相关文件
          echo "GUI files removed for Lite version"
        else
          echo "Warning: install directory not found"
        fi

    # 验证安装结果
    - name: Verify installations
      shell: bash
      run: |
        echo "=== Full Version (install) ==="
        echo "Executables:"
        find install -name "*.exe" -type f | while read exe; do
          echo "  - $(basename "$exe")"
        done
        echo ""
        
        echo "=== Lite Version (install-cli) ==="
        echo "Executables:"
        find install-cli -name "*.exe" -type f | while read exe; do
          echo "  - $(basename "$exe")"
        done
        
        echo ""
        echo "=== Summary ==="
        echo "Full version size:"
        du -sh install/
        echo "Lite version size:"
        du -sh install-cli/

    # 上传Full版本（包含所有GUI）
    - uses: actions/upload-artifact@v4
      with:
        name: MaaDxxw-win-${{ matrix.arch }}-Full
        path: "install"

    # 上传Lite版本（不包含GUI，只有CLI）
    - uses: actions/upload-artifact@v4
      with:
        name: MaaDxxw-win-${{ matrix.arch }}-Lite
        path: "install-cli"

  ubuntu:
    needs: meta
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [aarch64, x86_64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Download MaaFramework
        uses: robinraju/release-downloader@v1
        with:
          repository: MaaXYZ/MaaFramework
          fileName: "MAA-linux-${{ matrix.arch }}*"
          latest: true
          out-file-path: "deps"
          extract: true

      - name: Install
        shell: bash
        run: |
          python ./install.py ${{ needs.meta.outputs.tag }}

      - uses: actions/upload-artifact@v4
        with:
          name: MaaDxxw-linux-${{ matrix.arch }}
          path: "install"

  macos:
    needs: meta
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [aarch64, x86_64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Download MaaFramework
        uses: robinraju/release-downloader@v1
        with:
          repository: MaaXYZ/MaaFramework
          fileName: "MAA-macos-${{ matrix.arch }}*"
          latest: true
          out-file-path: "deps"
          extract: true

      - name: Install
        shell: bash
        run: |
          python ./install.py ${{ needs.meta.outputs.tag }}

      - uses: actions/upload-artifact@v4
        with:
          name: MaaDxxw-macos-${{ matrix.arch }}
          path: "install"

  android:
    needs: meta
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [aarch64, x86_64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Download MaaFramework
        uses: robinraju/release-downloader@v1
        with:
          repository: MaaXYZ/MaaFramework
          fileName: "MAA-android-${{ matrix.arch }}*"
          latest: true
          out-file-path: "deps"
          extract: true

      - name: Install
        shell: bash
        run: |
          python ./install.py ${{ needs.meta.outputs.tag }}

      - uses: actions/upload-artifact@v4
        with:
          name: MaaDxxw-android-${{ matrix.arch }}
          path: "install"

  release:
    if: ${{ needs.meta.outputs.is_release == 'true' }}
    needs: [meta, windows, ubuntu, macos, android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: assets

      - run: |
          cd assets
          for f in *; do
            (cd $f && zip -r ../$f-${{ needs.meta.outputs.tag }}.zip .)
          done
      - uses: softprops/action-gh-release@v2
        with:
          files: assets/*
          tag_name: ${{ needs.meta.outputs.tag }}
